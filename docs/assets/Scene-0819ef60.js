import{r as Y,e as St,d as Z,a as Lt,_ as wt,B as Ft,M as Rt,f as zt,Q as Mt,R as It,S as bt,g as Ht,V as kt,h as Yt,i as Vt,j as Dt,F as Ut,b as V,E as Zt,k as Bt,l as Nt,m as Xt}from"./index-dcd4c691.js";/*!
 * camera-controls
 * https://github.com/yomotsu/camera-controls
 * (c) 2017 @yomotsu
 * Released under the MIT License.
 */const p={LEFT:1,RIGHT:2,MIDDLE:4},o=Object.freeze({NONE:0,ROTATE:1,TRUCK:2,OFFSET:4,DOLLY:8,ZOOM:16,TOUCH_ROTATE:32,TOUCH_TRUCK:64,TOUCH_OFFSET:128,TOUCH_DOLLY:256,TOUCH_ZOOM:512,TOUCH_DOLLY_TRUCK:1024,TOUCH_DOLLY_OFFSET:2048,TOUCH_DOLLY_ROTATE:4096,TOUCH_ZOOM_TRUCK:8192,TOUCH_ZOOM_OFFSET:16384,TOUCH_ZOOM_ROTATE:32768}),K={NONE:0,IN:1,OUT:-1};function N(m){return m.isPerspectiveCamera}function B(m){return m.isOrthographicCamera}const Q=Math.PI*2,ft=Math.PI/2,xt=1e-5,j=Math.PI/180;function b(m,t,e){return Math.max(t,Math.min(e,m))}function A(m,t=xt){return Math.abs(m)<t}function U(m,t,e=xt){return A(m-t,e)}function Et(m,t){return Math.round(m/t)*t}function W(m){return isFinite(m)?m:m<0?-Number.MAX_VALUE:Number.MAX_VALUE}function J(m){return Math.abs(m)<Number.MAX_VALUE?m:m*(1/0)}function it(m,t,e,s,r=1/0,n){s=Math.max(1e-4,s);const h=2/s,l=h*n,c=1/(1+l+.48*l*l+.235*l*l*l);let _=m-t;const O=t,E=r*s;_=b(_,-E,E),t=m-_;const L=(e.value+h*_)*n;e.value=(e.value-h*L)*c;let g=t+(_+L)*c;return O-m>0==g>O&&(g=O,e.value=(g-O)/n),g}function gt(m,t,e,s,r=1/0,n,h){s=Math.max(1e-4,s);const l=2/s,c=l*n,_=1/(1+c+.48*c*c+.235*c*c*c);let O=t.x,E=t.y,L=t.z,g=m.x-O,P=m.y-E,v=m.z-L;const S=O,w=E,x=L,F=r*s,i=F*F,a=g*g+P*P+v*v;if(a>i){const at=Math.sqrt(a);g=g/at*F,P=P/at*F,v=v/at*F}O=m.x-g,E=m.y-P,L=m.z-v;const f=(e.x+l*g)*n,u=(e.y+l*P)*n,C=(e.z+l*v)*n;e.x=(e.x-l*f)*_,e.y=(e.y-l*u)*_,e.z=(e.z-l*C)*_,h.x=O+(g+f)*_,h.y=E+(P+u)*_,h.z=L+(v+C)*_;const T=S-m.x,R=w-m.y,M=x-m.z,et=h.x-S,st=h.y-w,Pt=h.z-x;return T*et+R*st+M*Pt>0&&(h.x=S,h.y=w,h.z=x,e.x=(h.x-S)/n,e.y=(h.y-w)/n,e.z=(h.z-x)/n),h}function ht(m,t){t.set(0,0),m.forEach(e=>{t.x+=e.clientX,t.y+=e.clientY}),t.x/=m.length,t.y/=m.length}function lt(m,t){return B(m)?(console.warn(`${t} is not supported in OrthographicCamera`),!0):!1}class Kt{constructor(){this._listeners={}}addEventListener(t,e){const s=this._listeners;s[t]===void 0&&(s[t]=[]),s[t].indexOf(e)===-1&&s[t].push(e)}hasEventListener(t,e){const s=this._listeners;return s[t]!==void 0&&s[t].indexOf(e)!==-1}removeEventListener(t,e){const r=this._listeners[t];if(r!==void 0){const n=r.indexOf(e);n!==-1&&r.splice(n,1)}}removeAllEventListeners(t){if(!t){this._listeners={};return}Array.isArray(this._listeners[t])&&(this._listeners[t].length=0)}dispatchEvent(t){const s=this._listeners[t.type];if(s!==void 0){t.target=this;const r=s.slice(0);for(let n=0,h=r.length;n<h;n++)r[n].call(this,t)}}}const Qt="2.7.4",ot=1/8,At=typeof window<"u",Gt=At&&/Mac/.test(navigator.platform),qt=!(At&&"PointerEvent"in window);let d,yt,nt,ct,z,y,D,G,$,H,k,X,Tt,Ot,I,tt,q,Ct,_t,vt,dt,mt,rt,pt=class ut extends Kt{static install(t){d=t.THREE,yt=Object.freeze(new d.Vector3(0,0,0)),nt=Object.freeze(new d.Vector3(0,1,0)),ct=Object.freeze(new d.Vector3(0,0,1)),z=new d.Vector2,y=new d.Vector3,D=new d.Vector3,G=new d.Vector3,$=new d.Vector3,H=new d.Vector3,k=new d.Vector3,X=new d.Vector3,Tt=new d.Vector3,Ot=new d.Vector3,I=new d.Spherical,tt=new d.Spherical,q=new d.Box3,Ct=new d.Box3,_t=new d.Sphere,vt=new d.Quaternion,dt=new d.Quaternion,mt=new d.Matrix4,rt=new d.Raycaster}static get ACTION(){return o}constructor(t,e){super(),this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.minDistance=Number.EPSILON,this.maxDistance=1/0,this.infinityDolly=!1,this.minZoom=.01,this.maxZoom=1/0,this.smoothTime=.25,this.draggingSmoothTime=.125,this.maxSpeed=1/0,this.azimuthRotateSpeed=1,this.polarRotateSpeed=1,this.dollySpeed=1,this.dollyDragInverted=!1,this.truckSpeed=2,this.dollyToCursor=!1,this.dragToOffset=!1,this.verticalDragToForward=!1,this.boundaryFriction=0,this.restThreshold=.01,this.colliderMeshes=[],this.cancel=()=>{},this._enabled=!0,this._state=o.NONE,this._viewport=null,this._changedDolly=0,this._changedZoom=0,this._hasRested=!0,this._boundaryEnclosesCamera=!1,this._needsUpdate=!0,this._updatedLastTime=!1,this._elementRect=new DOMRect,this._isDragging=!1,this._dragNeedsUpdate=!0,this._activePointers=[],this._lockedPointer=null,this._interactiveArea=new DOMRect(0,0,1,1),this._isUserControllingRotate=!1,this._isUserControllingDolly=!1,this._isUserControllingTruck=!1,this._isUserControllingOffset=!1,this._isUserControllingZoom=!1,this._lastDollyDirection=K.NONE,this._thetaVelocity={value:0},this._phiVelocity={value:0},this._radiusVelocity={value:0},this._targetVelocity=new d.Vector3,this._focalOffsetVelocity=new d.Vector3,this._zoomVelocity={value:0},this._truckInternal=(i,a,f)=>{let u,C;if(N(this._camera)){const T=y.copy(this._camera.position).sub(this._target),R=this._camera.getEffectiveFOV()*j,M=T.length()*Math.tan(R*.5);u=this.truckSpeed*i*M/this._elementRect.height,C=this.truckSpeed*a*M/this._elementRect.height}else if(B(this._camera)){const T=this._camera;u=i*(T.right-T.left)/T.zoom/this._elementRect.width,C=a*(T.top-T.bottom)/T.zoom/this._elementRect.height}else return;this.verticalDragToForward?(f?this.setFocalOffset(this._focalOffsetEnd.x+u,this._focalOffsetEnd.y,this._focalOffsetEnd.z,!0):this.truck(u,0,!0),this.forward(-C,!0)):f?this.setFocalOffset(this._focalOffsetEnd.x+u,this._focalOffsetEnd.y+C,this._focalOffsetEnd.z,!0):this.truck(u,C,!0)},this._rotateInternal=(i,a)=>{const f=Q*this.azimuthRotateSpeed*i/this._elementRect.height,u=Q*this.polarRotateSpeed*a/this._elementRect.height;this.rotate(f,u,!0)},this._dollyInternal=(i,a,f)=>{const u=Math.pow(.95,-i*this.dollySpeed),C=this._sphericalEnd.radius,T=this._sphericalEnd.radius*u,R=b(T,this.minDistance,this.maxDistance),M=R-T;this.infinityDolly&&this.dollyToCursor?this._dollyToNoClamp(T,!0):this.infinityDolly&&!this.dollyToCursor?(this.dollyInFixed(M,!0),this._dollyToNoClamp(R,!0)):this._dollyToNoClamp(R,!0),this.dollyToCursor&&(this._changedDolly+=(this.infinityDolly?T:R)-C,this._dollyControlCoord.set(a,f)),this._lastDollyDirection=Math.sign(-i)},this._zoomInternal=(i,a,f)=>{const u=Math.pow(.95,i*this.dollySpeed),C=this._zoom,T=this._zoom*u;this.zoomTo(T,!0),this.dollyToCursor&&(this._changedZoom+=T-C,this._dollyControlCoord.set(a,f))},typeof d>"u"&&console.error("camera-controls: `THREE` is undefined. You must first run `CameraControls.install( { THREE: THREE } )`. Check the docs for further information."),this._camera=t,this._yAxisUpSpace=new d.Quaternion().setFromUnitVectors(this._camera.up,nt),this._yAxisUpSpaceInverse=this._yAxisUpSpace.clone().invert(),this._state=o.NONE,this._target=new d.Vector3,this._targetEnd=this._target.clone(),this._focalOffset=new d.Vector3,this._focalOffsetEnd=this._focalOffset.clone(),this._spherical=new d.Spherical().setFromVector3(y.copy(this._camera.position).applyQuaternion(this._yAxisUpSpace)),this._sphericalEnd=this._spherical.clone(),this._lastDistance=this._spherical.radius,this._zoom=this._camera.zoom,this._zoomEnd=this._zoom,this._lastZoom=this._zoom,this._nearPlaneCorners=[new d.Vector3,new d.Vector3,new d.Vector3,new d.Vector3],this._updateNearPlaneCorners(),this._boundary=new d.Box3(new d.Vector3(-1/0,-1/0,-1/0),new d.Vector3(1/0,1/0,1/0)),this._cameraUp0=this._camera.up.clone(),this._target0=this._target.clone(),this._position0=this._camera.position.clone(),this._zoom0=this._zoom,this._focalOffset0=this._focalOffset.clone(),this._dollyControlCoord=new d.Vector2,this.mouseButtons={left:o.ROTATE,middle:o.DOLLY,right:o.TRUCK,wheel:N(this._camera)?o.DOLLY:B(this._camera)?o.ZOOM:o.NONE},this.touches={one:o.TOUCH_ROTATE,two:N(this._camera)?o.TOUCH_DOLLY_TRUCK:B(this._camera)?o.TOUCH_ZOOM_TRUCK:o.NONE,three:o.TOUCH_TRUCK};const s=new d.Vector2,r=new d.Vector2,n=new d.Vector2,h=i=>{if(!this._enabled||!this._domElement)return;if(this._interactiveArea.left!==0||this._interactiveArea.top!==0||this._interactiveArea.width!==1||this._interactiveArea.height!==1){const u=this._domElement.getBoundingClientRect(),C=i.clientX/u.width,T=i.clientY/u.height;if(C<this._interactiveArea.left||C>this._interactiveArea.right||T<this._interactiveArea.top||T>this._interactiveArea.bottom)return}const a=i.pointerType!=="mouse"?null:(i.buttons&p.LEFT)===p.LEFT?p.LEFT:(i.buttons&p.MIDDLE)===p.MIDDLE?p.MIDDLE:(i.buttons&p.RIGHT)===p.RIGHT?p.RIGHT:null;if(a!==null){const u=this._findPointerByMouseButton(a);u&&this._disposePointer(u)}if((i.buttons&p.LEFT)===p.LEFT&&this._lockedPointer)return;const f={pointerId:i.pointerId,clientX:i.clientX,clientY:i.clientY,deltaX:0,deltaY:0,mouseButton:a};this._activePointers.push(f),this._domElement.ownerDocument.removeEventListener("pointermove",c,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",O),this._domElement.ownerDocument.addEventListener("pointermove",c,{passive:!1}),this._domElement.ownerDocument.addEventListener("pointerup",O),this._isDragging=!0,v(i)},l=i=>{if(!this._enabled||!this._domElement||this._lockedPointer)return;if(this._interactiveArea.left!==0||this._interactiveArea.top!==0||this._interactiveArea.width!==1||this._interactiveArea.height!==1){const u=this._domElement.getBoundingClientRect(),C=i.clientX/u.width,T=i.clientY/u.height;if(C<this._interactiveArea.left||C>this._interactiveArea.right||T<this._interactiveArea.top||T>this._interactiveArea.bottom)return}const a=(i.buttons&p.LEFT)===p.LEFT?p.LEFT:(i.buttons&p.MIDDLE)===p.MIDDLE?p.MIDDLE:(i.buttons&p.RIGHT)===p.RIGHT?p.RIGHT:null;if(a!==null){const u=this._findPointerByMouseButton(a);u&&this._disposePointer(u)}const f={pointerId:1,clientX:i.clientX,clientY:i.clientY,deltaX:0,deltaY:0,mouseButton:(i.buttons&p.LEFT)===p.LEFT?p.LEFT:(i.buttons&p.MIDDLE)===p.LEFT?p.MIDDLE:(i.buttons&p.RIGHT)===p.LEFT?p.RIGHT:null};this._activePointers.push(f),this._domElement.ownerDocument.removeEventListener("mousemove",_),this._domElement.ownerDocument.removeEventListener("mouseup",E),this._domElement.ownerDocument.addEventListener("mousemove",_),this._domElement.ownerDocument.addEventListener("mouseup",E),this._isDragging=!0,v(i)},c=i=>{i.cancelable&&i.preventDefault();const a=i.pointerId,f=this._lockedPointer||this._findPointerById(a);if(f){if(f.clientX=i.clientX,f.clientY=i.clientY,f.deltaX=i.movementX,f.deltaY=i.movementY,this._state=0,i.pointerType==="touch")switch(this._activePointers.length){case 1:this._state=this.touches.one;break;case 2:this._state=this.touches.two;break;case 3:this._state=this.touches.three;break}else(!this._isDragging&&this._lockedPointer||this._isDragging&&(i.buttons&p.LEFT)===p.LEFT)&&(this._state=this._state|this.mouseButtons.left),this._isDragging&&(i.buttons&p.MIDDLE)===p.MIDDLE&&(this._state=this._state|this.mouseButtons.middle),this._isDragging&&(i.buttons&p.RIGHT)===p.RIGHT&&(this._state=this._state|this.mouseButtons.right);S()}},_=i=>{const a=this._lockedPointer||this._findPointerById(1);a&&(a.clientX=i.clientX,a.clientY=i.clientY,a.deltaX=i.movementX,a.deltaY=i.movementY,this._state=0,(this._lockedPointer||(i.buttons&p.LEFT)===p.LEFT)&&(this._state=this._state|this.mouseButtons.left),(i.buttons&p.MIDDLE)===p.MIDDLE&&(this._state=this._state|this.mouseButtons.middle),(i.buttons&p.RIGHT)===p.RIGHT&&(this._state=this._state|this.mouseButtons.right),S())},O=i=>{const a=this._findPointerById(i.pointerId);if(!(a&&a===this._lockedPointer)){if(a&&this._disposePointer(a),i.pointerType==="touch")switch(this._activePointers.length){case 0:this._state=o.NONE;break;case 1:this._state=this.touches.one;break;case 2:this._state=this.touches.two;break;case 3:this._state=this.touches.three;break}else this._state=o.NONE;w()}},E=()=>{const i=this._findPointerById(1);i&&i===this._lockedPointer||(i&&this._disposePointer(i),this._state=o.NONE,w())};let L=-1;const g=i=>{if(!this._domElement||!this._enabled||this.mouseButtons.wheel===o.NONE)return;if(this._interactiveArea.left!==0||this._interactiveArea.top!==0||this._interactiveArea.width!==1||this._interactiveArea.height!==1){const T=this._domElement.getBoundingClientRect(),R=i.clientX/T.width,M=i.clientY/T.height;if(R<this._interactiveArea.left||R>this._interactiveArea.right||M<this._interactiveArea.top||M>this._interactiveArea.bottom)return}if(i.preventDefault(),this.dollyToCursor||this.mouseButtons.wheel===o.ROTATE||this.mouseButtons.wheel===o.TRUCK){const T=performance.now();L-T<1e3&&this._getClientRect(this._elementRect),L=T}const a=Gt?-1:-3,f=i.deltaMode===1?i.deltaY/a:i.deltaY/(a*10),u=this.dollyToCursor?(i.clientX-this._elementRect.x)/this._elementRect.width*2-1:0,C=this.dollyToCursor?(i.clientY-this._elementRect.y)/this._elementRect.height*-2+1:0;switch(this.mouseButtons.wheel){case o.ROTATE:{this._rotateInternal(i.deltaX,i.deltaY),this._isUserControllingRotate=!0;break}case o.TRUCK:{this._truckInternal(i.deltaX,i.deltaY,!1),this._isUserControllingTruck=!0;break}case o.OFFSET:{this._truckInternal(i.deltaX,i.deltaY,!0),this._isUserControllingOffset=!0;break}case o.DOLLY:{this._dollyInternal(-f,u,C),this._isUserControllingDolly=!0;break}case o.ZOOM:{this._zoomInternal(-f,u,C),this._isUserControllingZoom=!0;break}}this.dispatchEvent({type:"control"})},P=i=>{if(!(!this._domElement||!this._enabled)){if(this.mouseButtons.right===ut.ACTION.NONE){const a=i instanceof PointerEvent?i.pointerId:(i instanceof MouseEvent,0),f=this._findPointerById(a);f&&this._disposePointer(f),this._domElement.ownerDocument.removeEventListener("pointermove",c,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",O),this._domElement.ownerDocument.removeEventListener("mousemove",_),this._domElement.ownerDocument.removeEventListener("mouseup",E);return}i.preventDefault()}},v=i=>{if(!this._enabled)return;if(ht(this._activePointers,z),this._getClientRect(this._elementRect),s.copy(z),r.copy(z),this._activePointers.length>=2){const f=z.x-this._activePointers[1].clientX,u=z.y-this._activePointers[1].clientY,C=Math.sqrt(f*f+u*u);n.set(0,C);const T=(this._activePointers[0].clientX+this._activePointers[1].clientX)*.5,R=(this._activePointers[0].clientY+this._activePointers[1].clientY)*.5;r.set(T,R)}if(this._state=0,!i)this._lockedPointer&&(this._state=this._state|this.mouseButtons.left);else if("pointerType"in i&&i.pointerType==="touch")switch(this._activePointers.length){case 1:this._state=this.touches.one;break;case 2:this._state=this.touches.two;break;case 3:this._state=this.touches.three;break}else!this._lockedPointer&&(i.buttons&p.LEFT)===p.LEFT&&(this._state=this._state|this.mouseButtons.left),(i.buttons&p.MIDDLE)===p.MIDDLE&&(this._state=this._state|this.mouseButtons.middle),(i.buttons&p.RIGHT)===p.RIGHT&&(this._state=this._state|this.mouseButtons.right);((this._state&o.ROTATE)===o.ROTATE||(this._state&o.TOUCH_ROTATE)===o.TOUCH_ROTATE||(this._state&o.TOUCH_DOLLY_ROTATE)===o.TOUCH_DOLLY_ROTATE||(this._state&o.TOUCH_ZOOM_ROTATE)===o.TOUCH_ZOOM_ROTATE)&&(this._sphericalEnd.theta=this._spherical.theta,this._sphericalEnd.phi=this._spherical.phi,this._thetaVelocity.value=0,this._phiVelocity.value=0),((this._state&o.TRUCK)===o.TRUCK||(this._state&o.TOUCH_TRUCK)===o.TOUCH_TRUCK||(this._state&o.TOUCH_DOLLY_TRUCK)===o.TOUCH_DOLLY_TRUCK||(this._state&o.TOUCH_ZOOM_TRUCK)===o.TOUCH_ZOOM_TRUCK)&&(this._targetEnd.copy(this._target),this._targetVelocity.set(0,0,0)),((this._state&o.DOLLY)===o.DOLLY||(this._state&o.TOUCH_DOLLY)===o.TOUCH_DOLLY||(this._state&o.TOUCH_DOLLY_TRUCK)===o.TOUCH_DOLLY_TRUCK||(this._state&o.TOUCH_DOLLY_OFFSET)===o.TOUCH_DOLLY_OFFSET||(this._state&o.TOUCH_DOLLY_ROTATE)===o.TOUCH_DOLLY_ROTATE)&&(this._sphericalEnd.radius=this._spherical.radius,this._radiusVelocity.value=0),((this._state&o.ZOOM)===o.ZOOM||(this._state&o.TOUCH_ZOOM)===o.TOUCH_ZOOM||(this._state&o.TOUCH_ZOOM_TRUCK)===o.TOUCH_ZOOM_TRUCK||(this._state&o.TOUCH_ZOOM_OFFSET)===o.TOUCH_ZOOM_OFFSET||(this._state&o.TOUCH_ZOOM_ROTATE)===o.TOUCH_ZOOM_ROTATE)&&(this._zoomEnd=this._zoom,this._zoomVelocity.value=0),((this._state&o.OFFSET)===o.OFFSET||(this._state&o.TOUCH_OFFSET)===o.TOUCH_OFFSET||(this._state&o.TOUCH_DOLLY_OFFSET)===o.TOUCH_DOLLY_OFFSET||(this._state&o.TOUCH_ZOOM_OFFSET)===o.TOUCH_ZOOM_OFFSET)&&(this._focalOffsetEnd.copy(this._focalOffset),this._focalOffsetVelocity.set(0,0,0)),this.dispatchEvent({type:"controlstart"})},S=()=>{if(!this._enabled||!this._dragNeedsUpdate)return;this._dragNeedsUpdate=!1,ht(this._activePointers,z);const a=this._domElement&&document.pointerLockElement===this._domElement?this._lockedPointer||this._activePointers[0]:null,f=a?-a.deltaX:r.x-z.x,u=a?-a.deltaY:r.y-z.y;if(r.copy(z),((this._state&o.ROTATE)===o.ROTATE||(this._state&o.TOUCH_ROTATE)===o.TOUCH_ROTATE||(this._state&o.TOUCH_DOLLY_ROTATE)===o.TOUCH_DOLLY_ROTATE||(this._state&o.TOUCH_ZOOM_ROTATE)===o.TOUCH_ZOOM_ROTATE)&&(this._rotateInternal(f,u),this._isUserControllingRotate=!0),(this._state&o.DOLLY)===o.DOLLY||(this._state&o.ZOOM)===o.ZOOM){const C=this.dollyToCursor?(s.x-this._elementRect.x)/this._elementRect.width*2-1:0,T=this.dollyToCursor?(s.y-this._elementRect.y)/this._elementRect.height*-2+1:0,R=this.dollyDragInverted?-1:1;(this._state&o.DOLLY)===o.DOLLY?(this._dollyInternal(R*u*ot,C,T),this._isUserControllingDolly=!0):(this._zoomInternal(R*u*ot,C,T),this._isUserControllingZoom=!0)}if((this._state&o.TOUCH_DOLLY)===o.TOUCH_DOLLY||(this._state&o.TOUCH_ZOOM)===o.TOUCH_ZOOM||(this._state&o.TOUCH_DOLLY_TRUCK)===o.TOUCH_DOLLY_TRUCK||(this._state&o.TOUCH_ZOOM_TRUCK)===o.TOUCH_ZOOM_TRUCK||(this._state&o.TOUCH_DOLLY_OFFSET)===o.TOUCH_DOLLY_OFFSET||(this._state&o.TOUCH_ZOOM_OFFSET)===o.TOUCH_ZOOM_OFFSET||(this._state&o.TOUCH_DOLLY_ROTATE)===o.TOUCH_DOLLY_ROTATE||(this._state&o.TOUCH_ZOOM_ROTATE)===o.TOUCH_ZOOM_ROTATE){const C=z.x-this._activePointers[1].clientX,T=z.y-this._activePointers[1].clientY,R=Math.sqrt(C*C+T*T),M=n.y-R;n.set(0,R);const et=this.dollyToCursor?(r.x-this._elementRect.x)/this._elementRect.width*2-1:0,st=this.dollyToCursor?(r.y-this._elementRect.y)/this._elementRect.height*-2+1:0;(this._state&o.TOUCH_DOLLY)===o.TOUCH_DOLLY||(this._state&o.TOUCH_DOLLY_ROTATE)===o.TOUCH_DOLLY_ROTATE||(this._state&o.TOUCH_DOLLY_TRUCK)===o.TOUCH_DOLLY_TRUCK||(this._state&o.TOUCH_DOLLY_OFFSET)===o.TOUCH_DOLLY_OFFSET?(this._dollyInternal(M*ot,et,st),this._isUserControllingDolly=!0):(this._zoomInternal(M*ot,et,st),this._isUserControllingZoom=!0)}((this._state&o.TRUCK)===o.TRUCK||(this._state&o.TOUCH_TRUCK)===o.TOUCH_TRUCK||(this._state&o.TOUCH_DOLLY_TRUCK)===o.TOUCH_DOLLY_TRUCK||(this._state&o.TOUCH_ZOOM_TRUCK)===o.TOUCH_ZOOM_TRUCK)&&(this._truckInternal(f,u,!1),this._isUserControllingTruck=!0),((this._state&o.OFFSET)===o.OFFSET||(this._state&o.TOUCH_OFFSET)===o.TOUCH_OFFSET||(this._state&o.TOUCH_DOLLY_OFFSET)===o.TOUCH_DOLLY_OFFSET||(this._state&o.TOUCH_ZOOM_OFFSET)===o.TOUCH_ZOOM_OFFSET)&&(this._truckInternal(f,u,!0),this._isUserControllingOffset=!0),this.dispatchEvent({type:"control"})},w=()=>{ht(this._activePointers,z),r.copy(z),this._dragNeedsUpdate=!1,(this._activePointers.length===0||this._activePointers.length===1&&this._activePointers[0]===this._lockedPointer)&&(this._isDragging=!1),this._activePointers.length===0&&this._domElement&&(this._domElement.ownerDocument.removeEventListener("pointermove",c,{passive:!1}),this._domElement.ownerDocument.removeEventListener("mousemove",_),this._domElement.ownerDocument.removeEventListener("pointerup",O),this._domElement.ownerDocument.removeEventListener("mouseup",E),this.dispatchEvent({type:"controlend"}))};this.lockPointer=()=>{!this._enabled||!this._domElement||(this.cancel(),this._lockedPointer={pointerId:-1,clientX:0,clientY:0,deltaX:0,deltaY:0,mouseButton:null},this._activePointers.push(this._lockedPointer),this._domElement.ownerDocument.removeEventListener("pointermove",c,{passive:!1}),this._domElement.ownerDocument.removeEventListener("pointerup",O),this._domElement.requestPointerLock(),this._domElement.ownerDocument.addEventListener("pointerlockchange",x),this._domElement.ownerDocument.addEventListener("pointerlockerror",F),this._domElement.ownerDocument.addEventListener("pointermove",c,{passive:!1}),this._domElement.ownerDocument.addEventListener("pointerup",O),v())},this.unlockPointer=()=>{this._lockedPointer!==null&&(this._disposePointer(this._lockedPointer),this._lockedPointer=null),document.exitPointerLock(),this.cancel(),this._domElement&&(this._domElement.ownerDocument.removeEventListener("pointerlockchange",x),this._domElement.ownerDocument.removeEventListener("pointerlockerror",F))};const x=()=>{this._domElement&&this._domElement.ownerDocument.pointerLockElement===this._domElement||this.unlockPointer()},F=()=>{this.unlockPointer()};this._addAllEventListeners=i=>{this._domElement=i,this._domElement.style.touchAction="none",this._domElement.style.userSelect="none",this._domElement.style.webkitUserSelect="none",this._domElement.addEventListener("pointerdown",h),qt&&this._domElement.addEventListener("mousedown",l),this._domElement.addEventListener("pointercancel",O),this._domElement.addEventListener("wheel",g,{passive:!1}),this._domElement.addEventListener("contextmenu",P)},this._removeAllEventListeners=()=>{this._domElement&&(this._domElement.style.touchAction="",this._domElement.style.userSelect="",this._domElement.style.webkitUserSelect="",this._domElement.removeEventListener("pointerdown",h),this._domElement.removeEventListener("mousedown",l),this._domElement.removeEventListener("pointercancel",O),this._domElement.removeEventListener("wheel",g,{passive:!1}),this._domElement.removeEventListener("contextmenu",P),this._domElement.ownerDocument.removeEventListener("pointermove",c,{passive:!1}),this._domElement.ownerDocument.removeEventListener("mousemove",_),this._domElement.ownerDocument.removeEventListener("pointerup",O),this._domElement.ownerDocument.removeEventListener("mouseup",E),this._domElement.ownerDocument.removeEventListener("pointerlockchange",x),this._domElement.ownerDocument.removeEventListener("pointerlockerror",F))},this.cancel=()=>{this._state!==o.NONE&&(this._state=o.NONE,this._activePointers.length=0,w())},e&&this.connect(e),this.update(0)}get camera(){return this._camera}set camera(t){this._camera=t,this.updateCameraUp(),this._camera.updateProjectionMatrix(),this._updateNearPlaneCorners(),this._needsUpdate=!0}get enabled(){return this._enabled}set enabled(t){this._enabled=t,this._domElement&&(t?(this._domElement.style.touchAction="none",this._domElement.style.userSelect="none",this._domElement.style.webkitUserSelect="none"):(this.cancel(),this._domElement.style.touchAction="",this._domElement.style.userSelect="",this._domElement.style.webkitUserSelect=""))}get active(){return!this._hasRested}get currentAction(){return this._state}get distance(){return this._spherical.radius}set distance(t){this._spherical.radius===t&&this._sphericalEnd.radius===t||(this._spherical.radius=t,this._sphericalEnd.radius=t,this._needsUpdate=!0)}get azimuthAngle(){return this._spherical.theta}set azimuthAngle(t){this._spherical.theta===t&&this._sphericalEnd.theta===t||(this._spherical.theta=t,this._sphericalEnd.theta=t,this._needsUpdate=!0)}get polarAngle(){return this._spherical.phi}set polarAngle(t){this._spherical.phi===t&&this._sphericalEnd.phi===t||(this._spherical.phi=t,this._sphericalEnd.phi=t,this._needsUpdate=!0)}get boundaryEnclosesCamera(){return this._boundaryEnclosesCamera}set boundaryEnclosesCamera(t){this._boundaryEnclosesCamera=t,this._needsUpdate=!0}set interactiveArea(t){this._interactiveArea.width=b(t.width,0,1),this._interactiveArea.height=b(t.height,0,1),this._interactiveArea.x=b(t.x,0,1-this._interactiveArea.width),this._interactiveArea.y=b(t.y,0,1-this._interactiveArea.height)}addEventListener(t,e){super.addEventListener(t,e)}removeEventListener(t,e){super.removeEventListener(t,e)}rotate(t,e,s=!1){return this.rotateTo(this._sphericalEnd.theta+t,this._sphericalEnd.phi+e,s)}rotateAzimuthTo(t,e=!1){return this.rotateTo(t,this._sphericalEnd.phi,e)}rotatePolarTo(t,e=!1){return this.rotateTo(this._sphericalEnd.theta,t,e)}rotateTo(t,e,s=!1){this._isUserControllingRotate=!1;const r=b(t,this.minAzimuthAngle,this.maxAzimuthAngle),n=b(e,this.minPolarAngle,this.maxPolarAngle);this._sphericalEnd.theta=r,this._sphericalEnd.phi=n,this._sphericalEnd.makeSafe(),this._needsUpdate=!0,s||(this._spherical.theta=this._sphericalEnd.theta,this._spherical.phi=this._sphericalEnd.phi);const h=!s||U(this._spherical.theta,this._sphericalEnd.theta,this.restThreshold)&&U(this._spherical.phi,this._sphericalEnd.phi,this.restThreshold);return this._createOnRestPromise(h)}dolly(t,e=!1){return this.dollyTo(this._sphericalEnd.radius-t,e)}dollyTo(t,e=!1){return this._isUserControllingDolly=!1,this._lastDollyDirection=K.NONE,this._changedDolly=0,this._dollyToNoClamp(b(t,this.minDistance,this.maxDistance),e)}_dollyToNoClamp(t,e=!1){const s=this._sphericalEnd.radius;if(this.colliderMeshes.length>=1){const h=this._collisionTest(),l=U(h,this._spherical.radius);if(!(s>t)&&l)return Promise.resolve();this._sphericalEnd.radius=Math.min(t,h)}else this._sphericalEnd.radius=t;this._needsUpdate=!0,e||(this._spherical.radius=this._sphericalEnd.radius);const n=!e||U(this._spherical.radius,this._sphericalEnd.radius,this.restThreshold);return this._createOnRestPromise(n)}dollyInFixed(t,e=!1){this._targetEnd.add(this._getCameraDirection($).multiplyScalar(t)),e||this._target.copy(this._targetEnd);const s=!e||U(this._target.x,this._targetEnd.x,this.restThreshold)&&U(this._target.y,this._targetEnd.y,this.restThreshold)&&U(this._target.z,this._targetEnd.z,this.restThreshold);return this._createOnRestPromise(s)}zoom(t,e=!1){return this.zoomTo(this._zoomEnd+t,e)}zoomTo(t,e=!1){this._isUserControllingZoom=!1,this._zoomEnd=b(t,this.minZoom,this.maxZoom),this._needsUpdate=!0,e||(this._zoom=this._zoomEnd);const s=!e||U(this._zoom,this._zoomEnd,this.restThreshold);return this._changedZoom=0,this._createOnRestPromise(s)}pan(t,e,s=!1){return console.warn("`pan` has been renamed to `truck`"),this.truck(t,e,s)}truck(t,e,s=!1){this._camera.updateMatrix(),H.setFromMatrixColumn(this._camera.matrix,0),k.setFromMatrixColumn(this._camera.matrix,1),H.multiplyScalar(t),k.multiplyScalar(-e);const r=y.copy(H).add(k),n=D.copy(this._targetEnd).add(r);return this.moveTo(n.x,n.y,n.z,s)}forward(t,e=!1){y.setFromMatrixColumn(this._camera.matrix,0),y.crossVectors(this._camera.up,y),y.multiplyScalar(t);const s=D.copy(this._targetEnd).add(y);return this.moveTo(s.x,s.y,s.z,e)}elevate(t,e=!1){return y.copy(this._camera.up).multiplyScalar(t),this.moveTo(this._targetEnd.x+y.x,this._targetEnd.y+y.y,this._targetEnd.z+y.z,e)}moveTo(t,e,s,r=!1){this._isUserControllingTruck=!1;const n=y.set(t,e,s).sub(this._targetEnd);this._encloseToBoundary(this._targetEnd,n,this.boundaryFriction),this._needsUpdate=!0,r||this._target.copy(this._targetEnd);const h=!r||U(this._target.x,this._targetEnd.x,this.restThreshold)&&U(this._target.y,this._targetEnd.y,this.restThreshold)&&U(this._target.z,this._targetEnd.z,this.restThreshold);return this._createOnRestPromise(h)}lookInDirectionOf(t,e,s,r=!1){const l=y.set(t,e,s).sub(this._targetEnd).normalize().multiplyScalar(-this._sphericalEnd.radius).add(this._targetEnd);return this.setPosition(l.x,l.y,l.z,r)}fitToBox(t,e,{cover:s=!1,paddingLeft:r=0,paddingRight:n=0,paddingBottom:h=0,paddingTop:l=0}={}){const c=[],_=t.isBox3?q.copy(t):q.setFromObject(t);_.isEmpty()&&(console.warn("camera-controls: fitTo() cannot be used with an empty box. Aborting"),Promise.resolve());const O=Et(this._sphericalEnd.theta,ft),E=Et(this._sphericalEnd.phi,ft);c.push(this.rotateTo(O,E,e));const L=y.setFromSpherical(this._sphericalEnd).normalize(),g=vt.setFromUnitVectors(L,ct),P=U(Math.abs(L.y),1);P&&g.multiply(dt.setFromAxisAngle(nt,O)),g.multiply(this._yAxisUpSpaceInverse);const v=Ct.makeEmpty();D.copy(_.min).applyQuaternion(g),v.expandByPoint(D),D.copy(_.min).setX(_.max.x).applyQuaternion(g),v.expandByPoint(D),D.copy(_.min).setY(_.max.y).applyQuaternion(g),v.expandByPoint(D),D.copy(_.max).setZ(_.min.z).applyQuaternion(g),v.expandByPoint(D),D.copy(_.min).setZ(_.max.z).applyQuaternion(g),v.expandByPoint(D),D.copy(_.max).setY(_.min.y).applyQuaternion(g),v.expandByPoint(D),D.copy(_.max).setX(_.min.x).applyQuaternion(g),v.expandByPoint(D),D.copy(_.max).applyQuaternion(g),v.expandByPoint(D),v.min.x-=r,v.min.y-=h,v.max.x+=n,v.max.y+=l,g.setFromUnitVectors(ct,L),P&&g.premultiply(dt.invert()),g.premultiply(this._yAxisUpSpace);const S=v.getSize(y),w=v.getCenter(D).applyQuaternion(g);if(N(this._camera)){const x=this.getDistanceToFitBox(S.x,S.y,S.z,s);c.push(this.moveTo(w.x,w.y,w.z,e)),c.push(this.dollyTo(x,e)),c.push(this.setFocalOffset(0,0,0,e))}else if(B(this._camera)){const x=this._camera,F=x.right-x.left,i=x.top-x.bottom,a=s?Math.max(F/S.x,i/S.y):Math.min(F/S.x,i/S.y);c.push(this.moveTo(w.x,w.y,w.z,e)),c.push(this.zoomTo(a,e)),c.push(this.setFocalOffset(0,0,0,e))}return Promise.all(c)}fitToSphere(t,e){const s=[],n=t instanceof d.Sphere?_t.copy(t):ut.createBoundingSphere(t,_t);if(s.push(this.moveTo(n.center.x,n.center.y,n.center.z,e)),N(this._camera)){const h=this.getDistanceToFitSphere(n.radius);s.push(this.dollyTo(h,e))}else if(B(this._camera)){const h=this._camera.right-this._camera.left,l=this._camera.top-this._camera.bottom,c=2*n.radius,_=Math.min(h/c,l/c);s.push(this.zoomTo(_,e))}return s.push(this.setFocalOffset(0,0,0,e)),Promise.all(s)}setLookAt(t,e,s,r,n,h,l=!1){this._isUserControllingRotate=!1,this._isUserControllingDolly=!1,this._isUserControllingTruck=!1,this._lastDollyDirection=K.NONE,this._changedDolly=0;const c=D.set(r,n,h),_=y.set(t,e,s);this._targetEnd.copy(c),this._sphericalEnd.setFromVector3(_.sub(c).applyQuaternion(this._yAxisUpSpace)),this.normalizeRotations(),this._needsUpdate=!0,l||(this._target.copy(this._targetEnd),this._spherical.copy(this._sphericalEnd));const O=!l||U(this._target.x,this._targetEnd.x,this.restThreshold)&&U(this._target.y,this._targetEnd.y,this.restThreshold)&&U(this._target.z,this._targetEnd.z,this.restThreshold)&&U(this._spherical.theta,this._sphericalEnd.theta,this.restThreshold)&&U(this._spherical.phi,this._sphericalEnd.phi,this.restThreshold)&&U(this._spherical.radius,this._sphericalEnd.radius,this.restThreshold);return this._createOnRestPromise(O)}lerpLookAt(t,e,s,r,n,h,l,c,_,O,E,L,g,P=!1){this._isUserControllingRotate=!1,this._isUserControllingDolly=!1,this._isUserControllingTruck=!1,this._lastDollyDirection=K.NONE,this._changedDolly=0;const v=y.set(r,n,h),S=D.set(t,e,s);I.setFromVector3(S.sub(v).applyQuaternion(this._yAxisUpSpace));const w=G.set(O,E,L),x=D.set(l,c,_);tt.setFromVector3(x.sub(w).applyQuaternion(this._yAxisUpSpace)),this._targetEnd.copy(v.lerp(w,g));const F=tt.theta-I.theta,i=tt.phi-I.phi,a=tt.radius-I.radius;this._sphericalEnd.set(I.radius+a*g,I.phi+i*g,I.theta+F*g),this.normalizeRotations(),this._needsUpdate=!0,P||(this._target.copy(this._targetEnd),this._spherical.copy(this._sphericalEnd));const f=!P||U(this._target.x,this._targetEnd.x,this.restThreshold)&&U(this._target.y,this._targetEnd.y,this.restThreshold)&&U(this._target.z,this._targetEnd.z,this.restThreshold)&&U(this._spherical.theta,this._sphericalEnd.theta,this.restThreshold)&&U(this._spherical.phi,this._sphericalEnd.phi,this.restThreshold)&&U(this._spherical.radius,this._sphericalEnd.radius,this.restThreshold);return this._createOnRestPromise(f)}setPosition(t,e,s,r=!1){return this.setLookAt(t,e,s,this._targetEnd.x,this._targetEnd.y,this._targetEnd.z,r)}setTarget(t,e,s,r=!1){const n=this.getPosition(y),h=this.setLookAt(n.x,n.y,n.z,t,e,s,r);return this._sphericalEnd.phi=b(this._sphericalEnd.phi,this.minPolarAngle,this.maxPolarAngle),h}setFocalOffset(t,e,s,r=!1){this._isUserControllingOffset=!1,this._focalOffsetEnd.set(t,e,s),this._needsUpdate=!0,r||this._focalOffset.copy(this._focalOffsetEnd);const n=!r||U(this._focalOffset.x,this._focalOffsetEnd.x,this.restThreshold)&&U(this._focalOffset.y,this._focalOffsetEnd.y,this.restThreshold)&&U(this._focalOffset.z,this._focalOffsetEnd.z,this.restThreshold);return this._createOnRestPromise(n)}setOrbitPoint(t,e,s){this._camera.updateMatrixWorld(),H.setFromMatrixColumn(this._camera.matrixWorldInverse,0),k.setFromMatrixColumn(this._camera.matrixWorldInverse,1),X.setFromMatrixColumn(this._camera.matrixWorldInverse,2);const r=y.set(t,e,s),n=r.distanceTo(this._camera.position),h=r.sub(this._camera.position);H.multiplyScalar(h.x),k.multiplyScalar(h.y),X.multiplyScalar(h.z),y.copy(H).add(k).add(X),y.z=y.z+n,this.dollyTo(n,!1),this.setFocalOffset(-y.x,y.y,-y.z,!1),this.moveTo(t,e,s,!1)}setBoundary(t){if(!t){this._boundary.min.set(-1/0,-1/0,-1/0),this._boundary.max.set(1/0,1/0,1/0),this._needsUpdate=!0;return}this._boundary.copy(t),this._boundary.clampPoint(this._targetEnd,this._targetEnd),this._needsUpdate=!0}setViewport(t,e,s,r){if(t===null){this._viewport=null;return}this._viewport=this._viewport||new d.Vector4,typeof t=="number"?this._viewport.set(t,e,s,r):this._viewport.copy(t)}getDistanceToFitBox(t,e,s,r=!1){if(lt(this._camera,"getDistanceToFitBox"))return this._spherical.radius;const n=t/e,h=this._camera.getEffectiveFOV()*j,l=this._camera.aspect;return((r?n>l:n<l)?e:t/l)*.5/Math.tan(h*.5)+s*.5}getDistanceToFitSphere(t){if(lt(this._camera,"getDistanceToFitSphere"))return this._spherical.radius;const e=this._camera.getEffectiveFOV()*j,s=Math.atan(Math.tan(e*.5)*this._camera.aspect)*2,r=1<this._camera.aspect?e:s;return t/Math.sin(r*.5)}getTarget(t,e=!0){return(t&&t.isVector3?t:new d.Vector3).copy(e?this._targetEnd:this._target)}getPosition(t,e=!0){return(t&&t.isVector3?t:new d.Vector3).setFromSpherical(e?this._sphericalEnd:this._spherical).applyQuaternion(this._yAxisUpSpaceInverse).add(e?this._targetEnd:this._target)}getSpherical(t,e=!0){return(t&&t instanceof d.Spherical?t:new d.Spherical).copy(e?this._sphericalEnd:this._spherical)}getFocalOffset(t,e=!0){return(t&&t.isVector3?t:new d.Vector3).copy(e?this._focalOffsetEnd:this._focalOffset)}normalizeRotations(){this._sphericalEnd.theta=this._sphericalEnd.theta%Q,this._sphericalEnd.theta<0&&(this._sphericalEnd.theta+=Q),this._spherical.theta+=Q*Math.round((this._sphericalEnd.theta-this._spherical.theta)/Q)}reset(t=!1){if(!U(this._camera.up.x,this._cameraUp0.x)||!U(this._camera.up.y,this._cameraUp0.y)||!U(this._camera.up.z,this._cameraUp0.z)){this._camera.up.copy(this._cameraUp0);const s=this.getPosition(y);this.updateCameraUp(),this.setPosition(s.x,s.y,s.z)}const e=[this.setLookAt(this._position0.x,this._position0.y,this._position0.z,this._target0.x,this._target0.y,this._target0.z,t),this.setFocalOffset(this._focalOffset0.x,this._focalOffset0.y,this._focalOffset0.z,t),this.zoomTo(this._zoom0,t)];return Promise.all(e)}saveState(){this._cameraUp0.copy(this._camera.up),this.getTarget(this._target0),this.getPosition(this._position0),this._zoom0=this._zoom,this._focalOffset0.copy(this._focalOffset)}updateCameraUp(){this._yAxisUpSpace.setFromUnitVectors(this._camera.up,nt),this._yAxisUpSpaceInverse.copy(this._yAxisUpSpace).invert()}applyCameraUp(){const t=y.subVectors(this._target,this._camera.position).normalize(),e=D.crossVectors(t,this._camera.up);this._camera.up.crossVectors(e,t).normalize(),this._camera.updateMatrixWorld();const s=this.getPosition(y);this.updateCameraUp(),this.setPosition(s.x,s.y,s.z)}update(t){const e=this._sphericalEnd.theta-this._spherical.theta,s=this._sphericalEnd.phi-this._spherical.phi,r=this._sphericalEnd.radius-this._spherical.radius,n=Tt.subVectors(this._targetEnd,this._target),h=Ot.subVectors(this._focalOffsetEnd,this._focalOffset),l=this._zoomEnd-this._zoom;if(A(e))this._thetaVelocity.value=0,this._spherical.theta=this._sphericalEnd.theta;else{const E=this._isUserControllingRotate?this.draggingSmoothTime:this.smoothTime;this._spherical.theta=it(this._spherical.theta,this._sphericalEnd.theta,this._thetaVelocity,E,1/0,t),this._needsUpdate=!0}if(A(s))this._phiVelocity.value=0,this._spherical.phi=this._sphericalEnd.phi;else{const E=this._isUserControllingRotate?this.draggingSmoothTime:this.smoothTime;this._spherical.phi=it(this._spherical.phi,this._sphericalEnd.phi,this._phiVelocity,E,1/0,t),this._needsUpdate=!0}if(A(r))this._radiusVelocity.value=0,this._spherical.radius=this._sphericalEnd.radius;else{const E=this._isUserControllingDolly?this.draggingSmoothTime:this.smoothTime;this._spherical.radius=it(this._spherical.radius,this._sphericalEnd.radius,this._radiusVelocity,E,this.maxSpeed,t),this._needsUpdate=!0}if(A(n.x)&&A(n.y)&&A(n.z))this._targetVelocity.set(0,0,0),this._target.copy(this._targetEnd);else{const E=this._isUserControllingTruck?this.draggingSmoothTime:this.smoothTime;gt(this._target,this._targetEnd,this._targetVelocity,E,this.maxSpeed,t,this._target),this._needsUpdate=!0}if(A(h.x)&&A(h.y)&&A(h.z))this._focalOffsetVelocity.set(0,0,0),this._focalOffset.copy(this._focalOffsetEnd);else{const E=this._isUserControllingOffset?this.draggingSmoothTime:this.smoothTime;gt(this._focalOffset,this._focalOffsetEnd,this._focalOffsetVelocity,E,this.maxSpeed,t,this._focalOffset),this._needsUpdate=!0}if(A(l))this._zoomVelocity.value=0,this._zoom=this._zoomEnd;else{const E=this._isUserControllingZoom?this.draggingSmoothTime:this.smoothTime;this._zoom=it(this._zoom,this._zoomEnd,this._zoomVelocity,E,1/0,t)}if(this.dollyToCursor){if(N(this._camera)&&this._changedDolly!==0){const E=this._spherical.radius-this._lastDistance,L=this._camera,g=this._getCameraDirection($),P=y.copy(g).cross(L.up).normalize();P.lengthSq()===0&&(P.x=1);const v=D.crossVectors(P,g),S=this._sphericalEnd.radius*Math.tan(L.getEffectiveFOV()*j*.5),x=(this._sphericalEnd.radius-E-this._sphericalEnd.radius)/this._sphericalEnd.radius,F=G.copy(this._targetEnd).add(P.multiplyScalar(this._dollyControlCoord.x*S*L.aspect)).add(v.multiplyScalar(this._dollyControlCoord.y*S)),i=y.copy(this._targetEnd).lerp(F,x),a=this._lastDollyDirection===K.IN&&this._spherical.radius<=this.minDistance,f=this._lastDollyDirection===K.OUT&&this.maxDistance<=this._spherical.radius;if(this.infinityDolly&&(a||f)){this._sphericalEnd.radius-=E,this._spherical.radius-=E;const C=D.copy(g).multiplyScalar(-E);i.add(C)}this._boundary.clampPoint(i,i);const u=D.subVectors(i,this._targetEnd);this._targetEnd.copy(i),this._target.add(u),this._changedDolly-=E,A(this._changedDolly)&&(this._changedDolly=0)}else if(B(this._camera)&&this._changedZoom!==0){const E=this._zoom-this._lastZoom,L=this._camera,g=y.set(this._dollyControlCoord.x,this._dollyControlCoord.y,(L.near+L.far)/(L.near-L.far)).unproject(L),P=D.set(0,0,-1).applyQuaternion(L.quaternion),v=G.copy(g).add(P.multiplyScalar(-g.dot(L.up))),w=-(this._zoom-E-this._zoom)/this._zoom,x=this._getCameraDirection($),F=this._targetEnd.dot(x),i=y.copy(this._targetEnd).lerp(v,w),a=i.dot(x),f=x.multiplyScalar(a-F);i.sub(f),this._boundary.clampPoint(i,i);const u=D.subVectors(i,this._targetEnd);this._targetEnd.copy(i),this._target.add(u),this._changedZoom-=E,A(this._changedZoom)&&(this._changedZoom=0)}}this._camera.zoom!==this._zoom&&(this._camera.zoom=this._zoom,this._camera.updateProjectionMatrix(),this._updateNearPlaneCorners(),this._needsUpdate=!0),this._dragNeedsUpdate=!0;const c=this._collisionTest();this._spherical.radius=Math.min(this._spherical.radius,c),this._spherical.makeSafe(),this._camera.position.setFromSpherical(this._spherical).applyQuaternion(this._yAxisUpSpaceInverse).add(this._target),this._camera.lookAt(this._target),(!A(this._focalOffset.x)||!A(this._focalOffset.y)||!A(this._focalOffset.z))&&(this._camera.updateMatrixWorld(),H.setFromMatrixColumn(this._camera.matrix,0),k.setFromMatrixColumn(this._camera.matrix,1),X.setFromMatrixColumn(this._camera.matrix,2),H.multiplyScalar(this._focalOffset.x),k.multiplyScalar(-this._focalOffset.y),X.multiplyScalar(this._focalOffset.z),y.copy(H).add(k).add(X),this._camera.position.add(y)),this._boundaryEnclosesCamera&&this._encloseToBoundary(this._camera.position.copy(this._target),y.setFromSpherical(this._spherical).applyQuaternion(this._yAxisUpSpaceInverse),1);const O=this._needsUpdate;return O&&!this._updatedLastTime?(this._hasRested=!1,this.dispatchEvent({type:"wake"}),this.dispatchEvent({type:"update"})):O?(this.dispatchEvent({type:"update"}),A(e,this.restThreshold)&&A(s,this.restThreshold)&&A(r,this.restThreshold)&&A(n.x,this.restThreshold)&&A(n.y,this.restThreshold)&&A(n.z,this.restThreshold)&&A(h.x,this.restThreshold)&&A(h.y,this.restThreshold)&&A(h.z,this.restThreshold)&&A(l,this.restThreshold)&&!this._hasRested&&(this._hasRested=!0,this.dispatchEvent({type:"rest"}))):!O&&this._updatedLastTime&&this.dispatchEvent({type:"sleep"}),this._lastDistance=this._spherical.radius,this._lastZoom=this._zoom,this._updatedLastTime=O,this._needsUpdate=!1,O}toJSON(){return JSON.stringify({enabled:this._enabled,minDistance:this.minDistance,maxDistance:W(this.maxDistance),minZoom:this.minZoom,maxZoom:W(this.maxZoom),minPolarAngle:this.minPolarAngle,maxPolarAngle:W(this.maxPolarAngle),minAzimuthAngle:W(this.minAzimuthAngle),maxAzimuthAngle:W(this.maxAzimuthAngle),smoothTime:this.smoothTime,draggingSmoothTime:this.draggingSmoothTime,dollySpeed:this.dollySpeed,truckSpeed:this.truckSpeed,dollyToCursor:this.dollyToCursor,verticalDragToForward:this.verticalDragToForward,target:this._targetEnd.toArray(),position:y.setFromSpherical(this._sphericalEnd).add(this._targetEnd).toArray(),zoom:this._zoomEnd,focalOffset:this._focalOffsetEnd.toArray(),target0:this._target0.toArray(),position0:this._position0.toArray(),zoom0:this._zoom0,focalOffset0:this._focalOffset0.toArray()})}fromJSON(t,e=!1){const s=JSON.parse(t);this.enabled=s.enabled,this.minDistance=s.minDistance,this.maxDistance=J(s.maxDistance),this.minZoom=s.minZoom,this.maxZoom=J(s.maxZoom),this.minPolarAngle=s.minPolarAngle,this.maxPolarAngle=J(s.maxPolarAngle),this.minAzimuthAngle=J(s.minAzimuthAngle),this.maxAzimuthAngle=J(s.maxAzimuthAngle),this.smoothTime=s.smoothTime,this.draggingSmoothTime=s.draggingSmoothTime,this.dollySpeed=s.dollySpeed,this.truckSpeed=s.truckSpeed,this.dollyToCursor=s.dollyToCursor,this.verticalDragToForward=s.verticalDragToForward,this._target0.fromArray(s.target0),this._position0.fromArray(s.position0),this._zoom0=s.zoom0,this._focalOffset0.fromArray(s.focalOffset0),this.moveTo(s.target[0],s.target[1],s.target[2],e),I.setFromVector3(y.fromArray(s.position).sub(this._targetEnd).applyQuaternion(this._yAxisUpSpace)),this.rotateTo(I.theta,I.phi,e),this.dollyTo(I.radius,e),this.zoomTo(s.zoom,e),this.setFocalOffset(s.focalOffset[0],s.focalOffset[1],s.focalOffset[2],e),this._needsUpdate=!0}connect(t){if(this._domElement){console.warn("camera-controls is already connected.");return}t.setAttribute("data-camera-controls-version",Qt),this._addAllEventListeners(t),this._getClientRect(this._elementRect)}disconnect(){this.cancel(),this._removeAllEventListeners(),this._domElement&&(this._domElement.removeAttribute("data-camera-controls-version"),this._domElement=void 0)}dispose(){this.removeAllEventListeners(),this.disconnect()}_getTargetDirection(t){return t.setFromSpherical(this._spherical).divideScalar(this._spherical.radius).applyQuaternion(this._yAxisUpSpaceInverse)}_getCameraDirection(t){return this._getTargetDirection(t).negate()}_findPointerById(t){return this._activePointers.find(e=>e.pointerId===t)}_findPointerByMouseButton(t){return this._activePointers.find(e=>e.mouseButton===t)}_disposePointer(t){this._activePointers.splice(this._activePointers.indexOf(t),1)}_encloseToBoundary(t,e,s){const r=e.lengthSq();if(r===0)return t;const n=D.copy(e).add(t),l=this._boundary.clampPoint(n,G).sub(n),c=l.lengthSq();if(c===0)return t.add(e);if(c===r)return t;if(s===0)return t.add(e).add(l);{const _=1+s*c/e.dot(l);return t.add(D.copy(e).multiplyScalar(_)).add(l.multiplyScalar(1-s))}}_updateNearPlaneCorners(){if(N(this._camera)){const t=this._camera,e=t.near,s=t.getEffectiveFOV()*j,r=Math.tan(s*.5)*e,n=r*t.aspect;this._nearPlaneCorners[0].set(-n,-r,0),this._nearPlaneCorners[1].set(n,-r,0),this._nearPlaneCorners[2].set(n,r,0),this._nearPlaneCorners[3].set(-n,r,0)}else if(B(this._camera)){const t=this._camera,e=1/t.zoom,s=t.left*e,r=t.right*e,n=t.top*e,h=t.bottom*e;this._nearPlaneCorners[0].set(s,n,0),this._nearPlaneCorners[1].set(r,n,0),this._nearPlaneCorners[2].set(r,h,0),this._nearPlaneCorners[3].set(s,h,0)}}_collisionTest(){let t=1/0;if(!(this.colliderMeshes.length>=1)||lt(this._camera,"_collisionTest"))return t;const s=this._getTargetDirection($);mt.lookAt(yt,s,this._camera.up);for(let r=0;r<4;r++){const n=D.copy(this._nearPlaneCorners[r]);n.applyMatrix4(mt);const h=G.addVectors(this._target,n);rt.set(h,s),rt.far=this._spherical.radius+1;const l=rt.intersectObjects(this.colliderMeshes);l.length!==0&&l[0].distance<t&&(t=l[0].distance)}return t}_getClientRect(t){if(!this._domElement)return;const e=this._domElement.getBoundingClientRect();return t.x=e.left,t.y=e.top,this._viewport?(t.x+=this._viewport.x,t.y+=e.height-this._viewport.w-this._viewport.y,t.width=this._viewport.z,t.height=this._viewport.w):(t.width=e.width,t.height=e.height),t}_createOnRestPromise(t){return t?Promise.resolve():(this._hasRested=!1,this.dispatchEvent({type:"transitionstart"}),new Promise(e=>{const s=()=>{this.removeEventListener("rest",s),e()};this.addEventListener("rest",s)}))}_addAllEventListeners(t){}_removeAllEventListeners(){}get dampingFactor(){return console.warn(".dampingFactor has been deprecated. use smoothTime (in seconds) instead."),0}set dampingFactor(t){console.warn(".dampingFactor has been deprecated. use smoothTime (in seconds) instead.")}get draggingDampingFactor(){return console.warn(".draggingDampingFactor has been deprecated. use draggingSmoothTime (in seconds) instead."),0}set draggingDampingFactor(t){console.warn(".draggingDampingFactor has been deprecated. use draggingSmoothTime (in seconds) instead.")}static createBoundingSphere(t,e=new d.Sphere){const s=e,r=s.center;q.makeEmpty(),t.traverseVisible(h=>{h.isMesh&&q.expandByObject(h)}),q.getCenter(r);let n=0;return t.traverseVisible(h=>{if(!h.isMesh)return;const l=h,c=l.geometry.clone();c.applyMatrix4(l.matrixWorld);const O=c.attributes.position;for(let E=0,L=O.count;E<L;E++)y.fromBufferAttribute(O,E),n=Math.max(n,r.distanceToSquared(y))}),s.radius=Math.sqrt(n),s}};const jt=Y.forwardRef((m,t)=>{Y.useMemo(()=>{const a={Box3:Ft,MathUtils:{clamp:Rt.clamp},Matrix4:zt,Quaternion:Mt,Raycaster:It,Sphere:bt,Spherical:Ht,Vector2:kt,Vector3:Yt,Vector4:Vt};pt.install({THREE:a}),St({CameraControlsImpl:pt})},[]);const{camera:e,domElement:s,makeDefault:r,onStart:n,onEnd:h,onChange:l,regress:c,..._}=m,O=Z(a=>a.camera),E=Z(a=>a.gl),L=Z(a=>a.invalidate),g=Z(a=>a.events),P=Z(a=>a.setEvents),v=Z(a=>a.set),S=Z(a=>a.get),w=Z(a=>a.performance),x=e||O,F=s||g.connected||E.domElement,i=Y.useMemo(()=>new pt(x),[x]);return Lt((a,f)=>{i.enabled&&i.update(f)},-1),Y.useEffect(()=>(i.connect(F),()=>void i.disconnect()),[F,i]),Y.useEffect(()=>{const a=C=>{L(),c&&w.regress(),l&&l(C)},f=C=>{n&&n(C)},u=C=>{h&&h(C)};return i.addEventListener("update",a),i.addEventListener("controlstart",f),i.addEventListener("controlend",u),i.addEventListener("control",a),i.addEventListener("transitionstart",a),i.addEventListener("wake",a),()=>{i.removeEventListener("update",a),i.removeEventListener("controlstart",f),i.removeEventListener("controlend",u),i.removeEventListener("control",a),i.removeEventListener("transitionstart",a),i.removeEventListener("wake",a)}},[i,n,h,L,P,c,l]),Y.useEffect(()=>{if(r){const a=S().controls;return v({controls:i}),()=>v({controls:a})}},[r,i]),Y.createElement("primitive",wt({ref:t,object:i},_))});function Wt(){const m=Y.useRef(null),{nodes:t,materials:e}=Bt("/pmndrs.glb"),[s,r]=Y.useState(!1),[n,h]=Y.useState(!1),l=s?"hotpink":"orange";return Lt((c,_)=>{m.current&&(m.current.rotation.x+=_/2,m.current.rotation.y+=_/2)}),Dt(Ut,{children:[V(Nt,{ref:m,children:V("mesh",{geometry:t.cube.geometry,material:e.base,"material-color":l,scale:n?.3:.25,onClick:c=>(c.stopPropagation(),h(!n)),onPointerOver:c=>(c.stopPropagation(),r(!0)),onPointerOut:()=>r(!1)})}),V(Xt,{color:l,position:[0,-1.5,0],blur:3,opacity:.75})]})}function $t(){return Dt(Ut,{children:[V("color",{attach:"background",args:["#f0f0f0"]}),V("ambientLight",{}),V("pointLight",{position:[10,10,5]}),V(Wt,{}),V(Zt,{preset:"city"}),V(jt,{minPolarAngle:Math.PI/2,maxPolarAngle:Math.PI/2})]})}export{$t as default};
